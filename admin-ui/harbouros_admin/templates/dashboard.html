{% extends "base.html" %}
{% block body %}
<!-- TOP BAR -->
<div class="topbar">
    <div class="topbar-brand"><span class="topbar-brand-harbour">Harbour</span><span class="topbar-brand-os">OS</span></div>
    <div class="topbar-right">
        <span class="update-badge" id="topbar-updates" style="display:none" onclick="openApp('system')" title="Updates available">
            <span class="update-count">0</span>
        </span>
        <button class="topbar-btn" id="power-btn" onclick="togglePowerMenu()" title="Power">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><line x1="12" y1="2" x2="12" y2="12"/>
            </svg>
        </button>
        <div class="power-menu" id="power-menu" style="display:none">
            <button class="power-menu-item" onclick="powerAction('reboot')">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                </svg>
                Reboot
            </button>
            <button class="power-menu-item power-menu-danger" onclick="powerAction('shutdown')">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><line x1="12" y1="2" x2="12" y2="12"/>
                </svg>
                Shutdown
            </button>
        </div>
        <span id="topbar-hostname">harbouros</span>
        <span class="clock">--:--</span>
    </div>
</div>

<!-- DESKTOP -->
<div class="desktop">
    <div class="desktop-logo">
        <span class="topbar-brand-harbour">Harbour</span><span class="topbar-brand-os">OS</span>
    </div>
    <!-- App Grid -->
    <div class="app-grid">
        <div class="app-icon" onclick="openApp('plex')">
            <div class="app-icon-img plex">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L3 7v10l9 5 9-5V7l-9-5zm0 2.18L18.36 7.5 12 10.82 5.64 7.5 12 4.18zM5 9.12l6 3.33v6.43l-6-3.33V9.12zm8 9.76v-6.43l6-3.33v6.43l-6 3.33z"/></svg>
            </div>
            <span class="app-icon-label">Plex</span>
        </div>
        <div class="app-icon" onclick="openApp('nas')">
            <div class="app-icon-img nas">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/></svg>
            </div>
            <span class="app-icon-label">NAS Storage</span>
        </div>
        <div class="app-icon" onclick="openApp('network')">
            <div class="app-icon-img network">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
            </div>
            <span class="app-icon-label">Network</span>
        </div>
        <div class="app-icon" onclick="openApp('system')">
            <div class="app-icon-img system">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"/><rect x="9" y="9" width="6" height="6"/><line x1="9" y1="1" x2="9" y2="4"/><line x1="15" y1="1" x2="15" y2="4"/><line x1="9" y1="20" x2="9" y2="23"/><line x1="15" y1="20" x2="15" y2="23"/><line x1="20" y1="9" x2="23" y2="9"/><line x1="20" y1="14" x2="23" y2="14"/><line x1="1" y1="9" x2="4" y2="9"/><line x1="1" y1="14" x2="4" y2="14"/></svg>
            </div>
            <span class="app-icon-label">System</span>
        </div>
        <a class="app-icon" id="plex-web-link" target="_blank" rel="noopener">
            <div class="app-icon-img settings">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            </div>
            <span class="app-icon-label">Plex Settings</span>
        </a>
    </div>

    <!-- Widgets -->
    <div class="widgets">
        <div class="widget">
            <div class="widget-title">System</div>
            <div class="widget-grid">
                <div><div class="widget-stat-value" id="w-cpu">--</div><div class="widget-stat-label">CPU</div></div>
                <div><div class="widget-stat-value" id="w-ram">--</div><div class="widget-stat-label">Memory</div></div>
                <div><div class="widget-stat-value" id="w-temp">--</div><div class="widget-stat-label">Temp</div></div>
                <div><div class="widget-stat-value" id="w-uptime">--</div><div class="widget-stat-label">Uptime</div></div>
            </div>
        </div>
        <div class="widget">
            <div class="widget-title">Storage</div>
            <div class="widget-grid">
                <div><div class="widget-stat-value" id="w-disk-pct">--</div><div class="widget-stat-label">Disk Used</div></div>
                <div><div class="widget-stat-value" id="w-disk">--</div><div class="widget-stat-label">Capacity</div></div>
                <div><div class="widget-stat-value" id="w-mounts">--</div><div class="widget-stat-label">NAS Mounts</div></div>
                <div><div class="widget-stat-value" id="w-libraries">--</div><div class="widget-stat-label">Libraries</div></div>
            </div>
        </div>
        <div class="widget">
            <div class="widget-title">Libraries</div>
            <div class="widget-libraries" id="w-libraries-list">
                <div class="text-muted text-sm">Loading...</div>
            </div>
        </div>
        <div class="widget">
            <div class="widget-title">Plex</div>
            <div class="widget-grid">
                <div><div class="widget-stat-value" id="w-plex-status">--</div><div class="widget-stat-label">Status</div></div>
                <div><div class="widget-stat-value" id="w-plex-version">--</div><div class="widget-stat-label">Version</div></div>
                <div><div class="widget-stat-value" id="w-plex-uptime">--</div><div class="widget-stat-label">Uptime</div></div>
                <div><div class="widget-stat-value" id="w-plex-libs">--</div><div class="widget-stat-label">Libraries</div></div>
            </div>
        </div>
    </div>
</div>

<!-- BOTTOM DOCK -->
<div class="dock">
    <div class="dock-section">
        <span class="status-dot dot-ok" id="dock-plex-dot"></span>
        <span id="dock-plex-label">Plex Running</span>
    </div>
    <div class="dock-section">
        <span id="dock-ip">--</span>
    </div>
    <div class="dock-section">
        <span class="clock">--:--</span>
    </div>
</div>

<!-- ====================== MODALS ====================== -->

<!-- PLEX MODAL -->
<div class="modal-backdrop" id="modal-plex">
    <div class="modal">
        <div class="modal-header">
            <h2>Plex Media Server</h2>
            <button class="modal-close" onclick="closeApp('plex')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="plex-grid">
                <div class="plex-card">
                    <h3>Status</h3>
                    <div class="status-badge" id="plex-status">Loading...</div>
                    <div class="text-muted text-sm" id="plex-info" style="margin-top:0.4rem"></div>
                    <div class="form-actions" style="margin-top:0.75rem">
                        <button class="btn btn-primary btn-sm" onclick="plexAction('start')">Start</button>
                        <button class="btn btn-secondary btn-sm" onclick="plexAction('restart')">Restart</button>
                        <button class="btn btn-danger btn-sm" onclick="plexAction('stop')">Stop</button>
                    </div>
                    <div id="plex-action-msg" class="message" style="display:none"></div>
                </div>
                <div class="plex-card">
                    <h3>Plex Web UI</h3>
                    <p class="text-sm text-muted" style="margin-bottom:0.6rem">Manage libraries, users, and settings.</p>
                    <a id="plex-modal-link" class="btn btn-primary btn-sm" target="_blank" rel="noopener">Open Plex UI</a>
                </div>
            </div>
            <h2>Libraries</h2>
            <div id="plex-libraries-list"><span class="spinner"></span>Loading...</div>

            <h2 style="margin-top:1.25rem">Recently Added</h2>
            <div id="plex-recently-added"><span class="spinner"></span>Loading...</div>

            <h2 style="margin-top:1.25rem">Recent Logs</h2>
            <pre class="log-viewer" id="plex-logs">Loading...</pre>
            <button class="btn btn-sm btn-secondary" onclick="loadPlexLogs()" style="margin-top:0.5rem">Refresh</button>

            <h2 style="margin-top:1.25rem">Auto-Update Log</h2>
            <pre class="log-viewer" id="plex-update-logs" style="max-height:200px">Loading...</pre>
            <div class="form-actions" style="margin-top:0.5rem">
                <button class="btn btn-sm btn-secondary" onclick="loadPlexUpdateLog()">Refresh</button>
                <button class="btn btn-sm btn-primary" onclick="triggerPlexUpdateCheck()">Check for Update Now</button>
            </div>
            <div id="plex-update-msg" class="message" style="display:none"></div>
        </div>
    </div>
</div>

<!-- NAS MODAL -->
<div class="modal-backdrop" id="modal-nas">
    <div class="modal">
        <div class="modal-header">
            <h2>NAS Storage</h2>
            <button class="modal-close" onclick="closeApp('nas')">&times;</button>
        </div>
        <div class="modal-body">
            <h2>Add NAS Mount</h2>
            <!-- Network Browser -->
            <div class="nas-browser">
                <div class="form-actions" style="margin-bottom:0.75rem">
                    <button type="button" class="btn btn-secondary btn-sm" id="btn-scan-network" onclick="scanNetwork()">Scan Network</button>
                    <span class="text-muted text-sm" id="scan-status"></span>
                </div>
                <div id="discovered-devices" style="display:none"></div>
                <div id="discovered-shares" style="display:none"></div>
            </div>
            <p class="text-muted text-sm" style="margin-bottom:0.75rem">Or enter details manually:</p>
            <form id="add-mount-form" class="form" onsubmit="addNasMount(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="mount-name" placeholder="e.g. Movies" required>
                    </div>
                    <div class="form-group">
                        <label>Protocol</label>
                        <select id="mount-type" onchange="toggleSmb()">
                            <option value="nfs">NFS (recommended)</option>
                            <option value="smb">SMB/CIFS</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>NAS IP / Hostname</label>
                        <input type="text" id="mount-host" placeholder="e.g. 192.168.1.100" required>
                    </div>
                    <div class="form-group">
                        <label>Share Path</label>
                        <input type="text" id="mount-share" placeholder="e.g. /media/Movies" required>
                    </div>
                </div>
                <div id="smb-fields" style="display:none">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" id="mount-user" placeholder="SMB username">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="mount-pass" placeholder="SMB password">
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary btn-sm" onclick="testNasConnection()">Test Connection</button>
                    <button type="submit" class="btn btn-primary btn-sm">Add Mount</button>
                </div>
                <div id="nas-test-msg" class="message" style="display:none"></div>
            </form>

            <h2 style="margin-top:1.25rem">Configured Mounts</h2>
            <div id="nas-mounts-list"><p class="text-muted text-sm">Loading...</p></div>
        </div>
    </div>
</div>

<!-- NETWORK MODAL -->
<div class="modal-backdrop" id="modal-network">
    <div class="modal">
        <div class="modal-header">
            <h2>Network</h2>
            <button class="modal-close" onclick="closeApp('network')">&times;</button>
        </div>
        <div class="modal-body">
            <h2>Current Configuration</h2>
            <table class="info-table">
                <tr><td>Hostname</td><td id="net-hostname">--</td></tr>
                <tr><td>mDNS</td><td id="net-mdns">--</td></tr>
                <tr><td>IP Address</td><td id="net-ip">--</td></tr>
                <tr><td>Interface</td><td id="net-iface">--</td></tr>
                <tr><td>Gateway</td><td id="net-gateway">--</td></tr>
                <tr><td>DNS</td><td id="net-dns">--</td></tr>
            </table>

            <h2 style="margin-top:1.25rem">Change Hostname</h2>
            <form class="form" onsubmit="setHostname(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>New Hostname</label>
                        <input type="text" id="new-hostname" placeholder="e.g. harbouros" required pattern="[a-zA-Z0-9-]+">
                    </div>
                    <div class="form-group" style="justify-content:flex-end">
                        <button type="submit" class="btn btn-primary btn-sm">Update</button>
                    </div>
                </div>
                <div id="hostname-msg" class="message" style="display:none"></div>
            </form>

            <h2 style="margin-top:1.25rem">IP Configuration</h2>
            <form class="form" onsubmit="setNetworkConfig(event)">
                <div class="form-group">
                    <label>Mode</label>
                    <select id="net-mode" onchange="toggleStaticFields()">
                        <option value="dhcp">DHCP (Automatic)</option>
                        <option value="static">Static IP</option>
                    </select>
                </div>
                <div id="static-ip-fields" style="display:none">
                    <div class="form-row">
                        <div class="form-group">
                            <label>IP Address</label>
                            <input type="text" id="net-static-ip" placeholder="e.g. 192.168.1.50" pattern="[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+">
                        </div>
                        <div class="form-group">
                            <label>Subnet Mask</label>
                            <input type="text" id="net-static-mask" placeholder="e.g. 255.255.255.0" value="255.255.255.0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Gateway</label>
                            <input type="text" id="net-static-gw" placeholder="e.g. 192.168.1.1">
                        </div>
                        <div class="form-group">
                            <label>DNS Servers</label>
                            <input type="text" id="net-static-dns" placeholder="e.g. 8.8.8.8, 8.8.4.4">
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-sm">Apply</button>
                </div>
                <div id="network-config-msg" class="message" style="display:none"></div>
            </form>

            <h2 style="margin-top:1.25rem">Access URLs</h2>
            <table class="info-table">
                <tr><td>Admin UI</td><td><a id="net-admin-url" target="_blank">--</a></td></tr>
                <tr><td>Plex Web</td><td><a id="net-plex-url" target="_blank">--</a></td></tr>
                <tr><td>SSH</td><td><code id="net-ssh">--</code></td></tr>
            </table>
        </div>
    </div>
</div>

<!-- SYSTEM MODAL -->
<div class="modal-backdrop" id="modal-system">
    <div class="modal">
        <div class="modal-header">
            <h2>System Management</h2>
            <button class="modal-close" onclick="closeApp('system')">&times;</button>
        </div>
        <div class="modal-body">
            <!-- Tab Navigation -->
            <div class="system-tabs">
                <button class="tab-btn active" onclick="showSystemTab('services', this)">Services</button>
                <button class="tab-btn" onclick="showSystemTab('logs', this)">Logs</button>
                <button class="tab-btn" onclick="showSystemTab('updates', this)">Updates</button>
                <button class="tab-btn" onclick="showSystemTab('storage', this)">Storage</button>
                <button class="tab-btn" onclick="showSystemTab('password', this)">Password</button>
            </div>

            <!-- Services Tab -->
            <div class="system-tab-content" id="tab-services">
                <h2>Service Status</h2>
                <div id="services-list"><span class="spinner"></span>Loading...</div>
            </div>

            <!-- Logs Tab -->
            <div class="system-tab-content" id="tab-logs" style="display:none">
                <h2>System Logs</h2>
                <div class="form-row" style="margin-bottom:0.75rem">
                    <div class="form-group">
                        <select id="log-service-filter" onchange="loadSystemLogs()">
                            <option value="all">All Services</option>
                            <option value="plexmediaserver">Plex Media Server</option>
                            <option value="harbouros">HarbourOS Admin</option>
                            <option value="nftables">Firewall (nftables)</option>
                            <option value="avahi-daemon">Avahi (mDNS)</option>
                            <option value="sshd">SSH</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex-direction:row;align-items:center;gap:0.5rem">
                        <button class="btn btn-sm btn-secondary" onclick="loadSystemLogs()">Refresh</button>
                        <label class="text-sm text-muted" style="display:inline-flex;align-items:center;gap:0.3rem">
                            <input type="checkbox" id="log-auto-refresh" onchange="toggleLogAutoRefresh()"> Auto
                        </label>
                    </div>
                </div>
                <pre class="log-viewer" id="system-logs" style="max-height:350px">Loading...</pre>
            </div>

            <!-- Updates Tab -->
            <div class="system-tab-content" id="tab-updates" style="display:none">
                <h2>OS Updates</h2>
                <div id="update-status">Checking...</div>
                <div class="form-actions" style="margin-top:0.75rem">
                    <button class="btn btn-primary btn-sm" id="btn-run-update" onclick="runSystemUpdate()">Install Updates</button>
                    <button class="btn btn-secondary btn-sm" onclick="checkUpdates()">Check Again</button>
                </div>
                <div id="update-msg" class="message" style="display:none"></div>
                <pre class="log-viewer" id="update-log" style="display:none;margin-top:0.75rem;max-height:250px"></pre>
            </div>

            <!-- Storage Tab -->
            <div class="system-tab-content" id="tab-storage" style="display:none">
                <h2>Disk Details</h2>
                <div id="storage-details"><span class="spinner"></span>Loading...</div>
                <h2 style="margin-top:1rem">NAS Mount Health</h2>
                <div id="storage-mounts"><span class="spinner"></span>Loading...</div>
            </div>

            <!-- Password Tab -->
            <div class="system-tab-content" id="tab-password" style="display:none">
                <h2>Change Password</h2>
                <form class="form" onsubmit="changePassword(event)">
                    <div class="form-group">
                        <label>Current Password</label>
                        <input type="password" id="pw-current" required>
                    </div>
                    <div class="form-group">
                        <label>New Password</label>
                        <input type="password" id="pw-new" required minlength="4">
                    </div>
                    <div class="form-group">
                        <label>Confirm New Password</label>
                        <input type="password" id="pw-confirm" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary btn-sm">Change Password</button>
                    </div>
                    <div id="password-msg" class="message" style="display:none"></div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Set Plex Settings link
document.getElementById('plex-web-link').href =
    window.location.protocol + '//' + window.location.hostname + ':32400/web';
document.getElementById('plex-modal-link').href =
    window.location.protocol + '//' + window.location.hostname + ':32400/web';
</script>
{% endblock %}
